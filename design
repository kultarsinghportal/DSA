title Salesforce Event Processing Flow
actor Sales
fontawesome5brands f83b Salesforce #skyblue
 SalesforceEventProcessorService as SEPS
 EventBus as Bus
 SalesforceEventMessageListener as Listener
 ChannelEventQueue as Queue
 MediatR as Mediator
 EventHandler as Handler
 ReplayIdsHashtable as ReplayID

alt Authentication
    loop up to 3 retries
        SEPS->SF: HTTP Client async request for Access Token (username, password, client ID, client secret, grant_type: password)
        alt Successful Authentication
            SF-->SEPS: Access Token Response
            break
        else Authentication Failed
            SF-->SEPS: Error Response (invalid_grant, invalid_client, etc.)
            SEPS->SEPS: Increment retry counter
        end
    end
    alt Exceeded Retry Limit
        SEPS->SEPS: Log Error & Alert for potential brute force attack
    else Authentication Permanently Failed
        SEPS->SEPS: Disable Account or Notify Admin
    end
end

alt Handshake
    loop up to 3 retries
        SEPS->SF: Bayeux Client Handshake via CometD with Access Token
        alt Handshake Successful
            SF-->SEPS: Handshake Acknowledged
            break
        else Handshake Failed
            SF-->SEPS: Error Response (Handshake failure reasons)
            SEPS->SEPS: Log Error & Increment handshake retry counter
        end
    end
    alt Exceeded Handshake Retry Limit
        SEPS->SEPS: Log Critical Error & Disable Handshake Attempts
    end
else Handshake Permanently Failed
    SEPS->SEPS: Disable Related Services or Notify Admin
end

alt Subscription
    loop up to 3 retries
        SEPS->SF: Subscribe to Event Channels using Bayeux protocol via CometD
        alt Subscription Successful
            SF-->SEPS: Subscription Acknowledged
            break
        else Subscription Failed
            SF-->SEPS: Error Response (Subscription failure reasons)
            SEPS->SEPS: Log Error & Increment subscription retry counter
        end
    end
    alt Exceeded Subscription Retry Limit
        SEPS->SEPS: Log Critical Error & Disable Subscription Attempts
    end
else Subscription Permanently Failed
    SEPS->SEPS: Notify Admin or Adjust Configuration
end

loop for each event
Sales -> Salesforce:Draft
    SF->SEPS: Publish Event using Bayeux protocol via CometD
    activate SEPS

    SEPS->Bus: Notify Event
    deactivate SEPS
    activate Bus

    Bus->Listener: Forward Event
    deactivate Bus
    activate Listener

    Listener->Queue: Enqueue Event
    deactivate Listener
    activate Queue

    alt Successful Enqueue
        Queue->Mediator: Send Event
        deactivate Queue
        activate Mediator

        alt Event Handled Successfully
            Mediator->Handler: Handle Event
            activate Handler
            Handler->Mediator: Event Processed
            deactivate Handler

            Mediator->ReplayID: Update Replay ID
            deactivate Mediator
            activate ReplayID
            ReplayID->Queue: Acknowledge & Fetch Next Event
            deactivate ReplayID
            activate Queue
        else Event Handling Failed
            Mediator->Queue: Handling Failed, Requeue or Discard
            deactivate Mediator
            activate Queue
        end
    else Failed to Enqueue
        Queue->Listener: Queue Full or Error
        deactivate Queue
        activate Listener
    end

    alt Listening for Next Event
        Queue->Listener: Listen for Next Event
        deactivate Queue
        activate Listener

        Listener->SF: Listen for Event via Bayeux protocol and CometD
        deactivate Listener
    else Reconnection Required
        SEPS->Bus: Attempt Reconnect via CometD
        activate SEPS
        Bus->SEPS: Reconnect Successful via CometD
        deactivate SEPS
        activate Bus
    end
end
