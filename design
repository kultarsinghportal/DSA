title Salesforce Event Processing Flow

actor Author

participant SF
participant CometD
participant Bus
participant Listener
participant Queue
participant Mediator
participant Handler
participant ReplayID

note right of SF: Streaming Events

alt Authentication
    CometD->SF: Request Access Token
    SF-->CometD: Access Token Response
else Authentication Failed
    CometD->CometD: Log Error & Retry Authentication
end

alt Handshake
    CometD->SF: Send Handshake with Token
    SF-->CometD: Handshake Acknowledged
else Handshake Failed
    CometD->CometD: Log Error & Retry Handshake
end

alt Subscription
    CometD->SF: Subscribe to Event Channels
    SF-->CometD: Subscription Acknowledged
else Subscription Failed
    CometD->CometD: Log Error & Retry Subscription
end

loop for each event
    Author -> SF:Publish Event
    SF->CometD: Publish Event
    activate CometD

    CometD->Bus: Notify Event
    deactivate CometD
    activate Bus

    Bus->Listener: Forward Event
    deactivate Bus
    activate Listener

    Listener->Queue: Enqueue Event
    deactivate Listener
    activate Queue

    alt Successful Enqueue
        Queue->Mediator: Send Event
        deactivate Queue
        activate Mediator

        alt Event Handled Successfully
            Mediator->Handler: Handle Event
            activate Handler
            Handler->Mediator: Event Processed
            deactivate Handler

            Mediator->ReplayID: Update Replay ID
            deactivate Mediator
            activate ReplayID
            ReplayID->Queue: Acknowledge & Fetch Next Event
            deactivate ReplayID
            activate Queue
        else Event Handling Failed
            Mediator->Queue: Handling Failed, Requeue or Discard
            deactivate Mediator
            activate Queue
        end
    else Failed to Enqueue
        Queue->Listener: Queue Full or Error
        deactivate Queue
        activate Listener
    end

    alt Listening for Next Event
        Queue->Listener: Listen for Next Event
        deactivate Queue
        activate Listener

        Listener->SF: Listen for Event
        deactivate Listener
    else Reconnection Required
        CometD->Bus: Attempt Reconnect
        activate CometD
        Bus->CometD: Reconnect Successful
        deactivate CometD
        activate Bus
    end
end
